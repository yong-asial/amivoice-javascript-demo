<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<title>AmiVoice DSR WebSocket Recognition Protocol Checker</title>
<script type="text/javascript" src="recorder.js"></script>
<script type="text/javascript" src="wrp.js"></script>
<style type="text/css">
table {table-layout: fixed;}
td {font-size: 14px; border: 1px solid #000;}
.text {font-size: 14px; font-family: inconsolata, consolas, monospace; width: 100%; height: 21px; margin: 0; padding: 2px; border: none; box-sizing: border-box;}
#messages div {
  padding: 3px 0;
  font-family: monospace;
}
#issueButton {
  height: 100%;
  cursor: pointer;
}
#resumePauseButton {
  height: 100%;
  cursor: pointer;
}
.recognitionResult {
  height: 60px;
  padding: 3px;
}
.recognitionResultText {
  font-size: 24px;
}
.recognitionResultInfo {
  font-size: 15px;
  color: lightgrey;
  float: right;
}
.sending {
  color: white;
  background: red;
}
.supplement {
  font-size: 12px;
}
.bar {
  position: relative;
}
#version {
  font-size: 10px;
  position: absolute;
  right: 0;
  top: -12px;
}
</style>
</head>
<body lang="ja">
<form>
<table border="0" width="100%" cellspacing="3" cellpadding="0">
 <tr><td width="240">&nbsp;ワンタイムAppKey発行API URL</td><td><input type="text" class="text" id="issuerURL" spellcheck="false" tabindex="1"></td></tr>
 <tr><td width="240">&nbsp;サービス ID</td><td><input type="text" class="text" id="sid" spellcheck="false" tabindex="1"></td></tr>
 <tr><td width="240">&nbsp;サービスパスワード</td><td><input type="password" class="text" id="spw" spellcheck="false" autocomplete="on" tabindex="1"></td></tr>
 <tr><td width="240">&nbsp;有効期限</td><td><input type="text" class="text" id="epi" spellcheck="false" tabindex="1"></td></tr>
 <tr>
  <td width="240" height="32">
   <input type="button" value="サービス認証キーの取得" class="text" id="issueButton" tabindex="2">
  </td>
  <td>
   &nbsp;
  </td>
 </tr>
</table>
</form>
<div style="margin: 20px 2px;">
 「サービス ID」「サービスパスワード」を入力した後に <b>[サービス認証キーの取得]</b> ボタンを押して、「サービス認証キー」を取得してください。
</div>
<table border="0" width="100%" cellspacing="3" cellpadding="0">
 <tr><td width="240">&nbsp;サーバ URL</td><td><input type="text" class="text" id="serverURL" spellcheck="false" tabindex="3"></td></tr>
 <tr><td width="240">&nbsp;接続エンジン名</td><td><input type="text" class="text grammarFileNames" spellcheck="false" tabindex="3"></td></tr>
 <tr><td width="240">&nbsp;APPKEY</td><td><input type="password" class="text" id="authorization" spellcheck="false" tabindex="3"></td></tr>
 <tr>
  <td width="240" height="100">
   <button class="text" id="resumePauseButton" tabindex="5">録音の開始</button>
  </td>
  <td class="recognitionResult">
   <span class="recognitionResultText"></span><span class="recognitionResultInfo"></span>
  </td>
 </tr>
</table>
<div style="margin: 20px 2px 24px 2px;">
 <b>[録音の開始]</b> ボタンを押して、マイクに向かって話してください。 <img src="data:image/gif;base64,R0lGODlhCgAPAMIAAAAAABYWFqqqqufn5////wAAAAAAAAAAACH5BAEKAAcALAAAAAAKAA8AAAMmSLq8E2E0AiqY9raMba/MxWmiRw4ZqgACdQka3BLyAltzqDF3NScAOw==" alt="" width="10" height="15"> マイクの使用や共有などを求められた場合は、「許可」 ボタンまたは 「共有」 ボタンを押してください。
</div>
<div class="bar"><hr><div id="version"></div></div>
<div id="messages"></div>
<script type="text/javascript">
(function() {
  // <!--
  function sanitize_(s) {
    return s.replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/'/g, '&apos;')
            .replace(/"/g, '&quot;');
  }
  var buffer;
  var bufferEnding;
  function append_(item) {
    if (item.length == 0) {
      return;
    }
    if (item == "<->") {
      return;
    }
    var itemState = 0;
    for (var i = 0; i < item.length; i++) {
      var c = item.charCodeAt(i);
      if (itemState == 0) {
        if (c == 0x005F) {
          break;
        } else
        if (c == 0x4E00 || c == 0x4E8C || c == 0x4E09 || c == 0x56DB || c == 0x4E94 || c == 0x516D || c == 0x4E03 || c == 0x516B || c == 0x4E5D) { // '一'～'九'
          itemState = 1;
        } else
        if (c == 0x5341) { // '十'
          itemState = 2;
        } else
        if (c == 0x767E) { // '百'
          itemState = 4;
        } else
        if (c == 0x5343) { // '千'
          itemState = 8;
        } else {
          break;
        }
      } else {
        if (c == 0x005F) {
          item = item.substr(0, i) + item.substr(i + 1);
          break;
        } else
        if (c == 0x4E00 || c == 0x4E8C || c == 0x4E09 || c == 0x56DB || c == 0x4E94 || c == 0x516D || c == 0x4E03 || c == 0x516B || c == 0x4E5D) { // '一'～'九'
          if ((itemState & 1) != 0) {
            break;
          } else {
            itemState |= 1;
          }
        } else
        if (c == 0x5341) { // '十'
          if ((itemState & 2) != 0) {
            break;
          } else {
            itemState |= 2;
            itemState &= ~1;
          }
        } else
        if (c == 0x767E) { // '百'
          if ((itemState & 6) != 0) {
            break;
          } else {
            itemState |= 4;
            itemState &= ~1;
          }
        } else
        if (c == 0x5343) { // '千'
          if ((itemState & 14) != 0) {
            break;
          } else {
            itemState |= 8;
            itemState &= ~1;
          }
        } else {
          break;
        }
      }
    }
    item = item.replace(/_/g, " ");
    var itemBeginningChar = item.charCodeAt(0);
    var itemEndingChar = (item.length > 1) ? item.charCodeAt(item.length - 1) : 0;
    if (bufferEnding == 0) {
      var itemBeginning;
      var c = itemBeginningChar;
      if (c == 0x0020) {
        itemBeginning = 0;
      } else
      if (c == 0x0021
       || c == 0x002C
       || c == 0x002E
       || c == 0x003A
       || c == 0x003B
       || c == 0x003F) {
        itemBeginning = 5;
      } else
      if (c == 0x3001
       || c == 0x3002
       || c == 0xFF01
       || c == 0xFF0C
       || c == 0xFF0E
       || c == 0xFF1A
       || c == 0xFF1B
       || c == 0xFF1F) {
        itemBeginning = 6;
      } else {
        itemBeginning = 7;
      }
      if (itemBeginning == 0
       || itemBeginning == 5
       || itemBeginning == 6) {
        if (buffer.length > 0) {
          buffer = buffer.substr(0, buffer.length - 1);
        }
      }
    } else {
      var itemBeginning;
      var c = itemBeginningChar;
      if (c == 0x0020) {
        itemBeginning = 0;
      } else
      if (c >= 0x0041 && c <= 0x005A
       || c >= 0x0061 && c <= 0x007A
       || c >= 0x0100 && c <= 0x0DFF
       || c >= 0x0E60 && c <= 0x01FF) {
        itemBeginning = 1;
      } else
      if (c >= 0xFF21 && c <= 0xFF3A
       || c >= 0xFF41 && c <= 0xFF5A) {
        itemBeginning = 2;
      } else
      if (c >= 0x0030 && c <= 0x0039) {
        itemBeginning = (bufferEnding == 8 && itemEndingChar == 0) ? 8 : 3;
      } else
      if (c >= 0xFF10 && c <= 0xFF19) {
        itemBeginning = (bufferEnding == 9 && itemEndingChar == 0) ? 9 : 4;
      } else
      if (c == 0x0021
       || c == 0x002C
       || c == 0x002E
       || c == 0x003A
       || c == 0x003B
       || c == 0x003F) {
        itemBeginning = 5;
      } else
      if (c == 0x3001
       || c == 0x3002
       || c == 0xFF01
       || c == 0xFF0C
       || c == 0xFF0E
       || c == 0xFF1A
       || c == 0xFF1B
       || c == 0xFF1F) {
        itemBeginning = 6;
      } else {
        itemBeginning = 7;
      }
      if (itemBeginning == 1 || bufferEnding == 1 && (itemBeginning == 2
                                                   || itemBeginning == 3
                                                   || itemBeginning == 4
                                                   || itemBeginning == 7)
                             || bufferEnding == 2 && (itemBeginning == 2)
                             || bufferEnding == 3 && (itemBeginning == 3
                                                   || itemBeginning == 4)
                             || bufferEnding == 4 && (itemBeginning == 3
                                                   || itemBeginning == 4)
                             || bufferEnding == 5 && (itemBeginning == 2
                                                   || itemBeginning == 3
                                                   || itemBeginning == 4
                                                   || itemBeginning == 7)
                             || bufferEnding == 8 && (itemBeginning == 3
                                                   || itemBeginning == 4)
                             || bufferEnding == 9 && (itemBeginning == 3
                                                   || itemBeginning == 4)) {
        buffer += " ";
      }
    }
    buffer += item;
    c = (itemEndingChar == 0) ? itemBeginningChar : itemEndingChar;
    if (c == 0x0020) {
      bufferEnding = 0;
    } else
    if (c >= 0x0041 && c <= 0x005A
     || c >= 0x0061 && c <= 0x007A
     || c >= 0x0100 && c <= 0x0DFF
     || c >= 0x0E60 && c <= 0x01FF) {
      bufferEnding = 1;
    } else
    if (c >= 0xFF21 && c <= 0xFF3A
     || c >= 0xFF41 && c <= 0xFF5A) {
      bufferEnding = 2;
    } else
    if (c >= 0x0030 && c <= 0x0039) {
      bufferEnding = (itemEndingChar == 0) ? 8 : 3;
    } else
    if (c >= 0xFF10 && c <= 0xFF19) {
      bufferEnding = (itemEndingChar == 0) ? 9 : 4;
    } else
    if (c == 0x0021
     || c == 0x002C
     || c == 0x002E
     || c == 0x003A
     || c == 0x003B
     || c == 0x003F) {
      bufferEnding = 5;
    } else
    if (c == 0x3001
     || c == 0x3002
     || c == 0xFF01
     || c == 0xFF0C
     || c == 0xFF0E
     || c == 0xFF1A
     || c == 0xFF1B
     || c == 0xFF1F) {
      bufferEnding = 6;
    } else {
      bufferEnding = 7;
    }
  }
  // -->
  // 音声認識サーバへの接続処理が開始した時に呼び出されます。
  function connectStarted() {
    // ボタンの制御
    resumePauseButton.disabled = true;
  }

  // 音声認識サーバへの接続処理が完了した時に呼び出されます。
  function connectEnded() {
  }

  // 音声認識サーバからの切断処理が開始した時に呼び出されます。
  function disconnectStarted() {
  }

  // 音声認識サーバからの切断処理が完了した時に呼び出されます。
  function disconnectEnded() {
    // ボタンの制御
    resumePauseButton.innerHTML = "録音の開始";
    resumePauseButton.disabled = false;
    resumePauseButton.classList.remove("sending");
  }

  // 音声認識サーバへの音声データの供給開始処理が開始した時に呼び出されます。
  function feedDataResumeStarted() {
  }

  // 音声認識サーバへの音声データの供給開始処理が完了した時に呼び出されます。
  function feedDataResumeEnded() {
    // ボタンの制御
    resumePauseButton.innerHTML = "<br><br>音声データの録音中...<br><br><span class=\"supplement\">クリック → 録音の停止</span>";
    resumePauseButton.disabled = false;
    resumePauseButton.classList.add("sending");
  }

  // 音声認識サーバへの音声データの供給終了処理が開始した時に呼び出されます。
  function feedDataPauseStarted() {
    // ボタンの制御
    resumePauseButton.disabled = true;
  }

  // 音声認識サーバへの音声データの供給終了処理が完了した時に呼び出されます。
  function feedDataPauseEnded(reason) {
  }

  // 発話区間の始端が検出された時に呼び出されます。
  function utteranceStarted(startTime) {
  }

  // 発話区間の終端が検出された時に呼び出されます。
  function utteranceEnded(endTime) {
  }

  // 認識処理が開始された時に呼び出されます。
  function resultCreated() {
    this.recognitionResultText.innerHTML = "...";
    this.recognitionResultInfo.innerHTML = "";
    this.time2 = new Date().getTime();
  }

  // 認識処理中に呼び出されます。
  function resultUpdated(result) {
    try {
      var json = JSON.parse(result);
      buffer = (json.text) ? sanitize_(json.text) : "...";
    } catch (e) {
      if (result.indexOf("\x01") == -1) {
        buffer = (result) ? sanitize_(result) : "...";
      } else {
        var fields = result.split("\x01");
        var fields0 = fields[0].split("|");
        // <!--
        buffer = "";
        bufferEnding = 0;
        // -->
        var i, j;
        for (i = 0; i < fields0.length; i++) {
          var written = fields0[i];
          if ((j = written.indexOf(" ")) != -1) {
            written = written.slice(0, j);
          }
          if ((j = written.indexOf(":")) != -1) {
            written = written.slice(0, j);
          }
          if ((j = written.indexOf("\x03")) != -1) {
            written = written.slice(0, j);
          }
          // <!--
          append_(written);
          // -->
        }
        buffer = (buffer) ? sanitize_(buffer) : "...";
      }
    }
    this.recognitionResultText.innerHTML = buffer;
  }

  // 認識処理が確定した時に呼び出されます。
  function resultFinalized(result) {
    this.time0 = 0;
    this.time2 = new Date().getTime() - this.time2;
    this.confidence = -1.0;
    try {
      var json = JSON.parse(result);
      buffer = (json.text) ? sanitize_(json.text) : (json.code != 'o' && json.message) ? "<font color=\"gray\">(" + json.message + ")</font>" : "<font color=\"gray\">(なし)</font>";
      if (json.results && json.results[0]) {
        if (this.time0 == 0) {
          this.time0 = json.results[0].endtime;
        }
        this.confidence = json.results[0].confidence;
      }
    } catch (e) {
      if (result.indexOf("\x01") == -1) {
        buffer = (result) ? sanitize_(result) : "<font color=\"gray\">(なし)</font>";
      } else {
        var fields = result.split("\x01");
        var fields0 = fields[0].split("|");
        // <!--
        buffer = "";
        bufferEnding = 0;
        // -->
        var i, j;
        for (i = 0; i < fields0.length; i++) {
          var written = fields0[i];
          if ((j = written.indexOf(" ")) != -1) {
            written = written.slice(0, j);
          }
          if ((j = written.indexOf(":")) != -1) {
            written = written.slice(0, j);
          }
          if ((j = written.indexOf("\x03")) != -1) {
            written = written.slice(0, j);
          }
          // <!--
          append_(written);
          // -->
        }
        buffer = (buffer) ? sanitize_(buffer) : "<font color=\"gray\">(なし)</font>";
        if (this.time0 == 0) {
          this.time0 = parseInt(fields[2].split("-")[1]);
        }
        this.confidence = parseFloat(fields[1]);
      }
    }
    var rt = ((this.time0 > 0) ? (this.time2 / this.time0).toFixed(2) : "-") + " (" + (this.time2 / 1000).toFixed(2) + "/" + ((this.time0 > 0) ? (this.time0 / 1000).toFixed(2) : "-") + ")";
    var cf = (this.confidence >= 0.0) ? this.confidence.toFixed(2) : "-";
    this.recognitionResultText.innerHTML = buffer;
    this.recognitionResultInfo.innerHTML = "RT: " + rt + "<br>CF: " + cf;
  }

  // メッセージの出力が要求された時に呼び出されます。
  function TRACE(message) {
  }

  // 画面要素の取得
  var issuerURL = document.getElementById("issuerURL");
  var sid = document.getElementById("sid");
  var spw = document.getElementById("spw");
  var epi = document.getElementById("epi");
  var issueButton = document.getElementById("issueButton");
  var grammarFileNames =document.getElementsByClassName("grammarFileNames");
  var recognitionResultText =document.getElementsByClassName("recognitionResultText");
  var recognitionResultInfo =document.getElementsByClassName("recognitionResultInfo");

  // 画面要素の初期化
  issuerURL.value = "https://acp-api.amivoice.com/issue_service_authorization";
  serverURL.value = "wss://acp-api.amivoice.com/v1/";
  grammarFileNames[0].value = Wrp.grammarFileNames;
  authorization.value = Wrp.authorization;

  // 音声認識ライブラリのプロパティ要素の設定
  Wrp.serverURLElement = serverURL;
  Wrp.grammarFileNamesElement = grammarFileNames[0];
  Wrp.authorizationElement = authorization;
  Wrp.issuerURLElement = issuerURL;
  Wrp.sidElement = sid;
  Wrp.spwElement = spw;
  Wrp.epiElement = epi;
  Wrp.name = "";
  Wrp.recognitionResultText = recognitionResultText[0];
  Wrp.recognitionResultInfo = recognitionResultInfo[0];

  // 音声認識ライブラリのイベントハンドラの設定
  Wrp.connectStarted = connectStarted;
  Wrp.connectEnded = connectEnded;
  Wrp.disconnectStarted = disconnectStarted;
  Wrp.disconnectEnded = disconnectEnded;
  Wrp.feedDataResumeStarted = feedDataResumeStarted;
  Wrp.feedDataResumeEnded = feedDataResumeEnded;
  Wrp.feedDataPauseStarted = feedDataPauseStarted;
  Wrp.feedDataPauseEnded = feedDataPauseEnded;
  Wrp.utteranceStarted = utteranceStarted;
  Wrp.utteranceEnded = utteranceEnded;
  Wrp.resultCreated = resultCreated;
  Wrp.resultUpdated = resultUpdated;
  Wrp.resultFinalized = resultFinalized;
  Wrp.TRACE = TRACE;

  // 音声認識ライブラリ／録音ライブラリのメソッドの画面要素への登録
  resumePauseButton.onclick = function() {
    // 音声認識サーバへの音声データの供給中かどうかのチェック
    if (Wrp.isActive()) {
      // 音声認識サーバへの音声データの供給中の場合...
      // 音声認識サーバへの音声データの供給の停止
      Wrp.feedDataPause();
    } else {
      // 音声認識サーバへの音声データの供給中でない場合...
      // 音声認識サーバへの音声データの供給の開始
      Wrp.feedDataResume();
    }
  };
  issueButton.onclick = Wrp.issue;

  version.innerHTML = Wrp.version;
})();
</script>
</body>
</html>
